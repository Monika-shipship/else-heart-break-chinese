# Else Heart.Break() 中文润色与批处理技术说明（必读）

本说明面向本仓库的中文润色维护者，详细说明如何在大批量场景下稳定、可追踪地润色右侧译文，同时绝不触碰左侧瑞典语原文（含 å/ä/ö 变音）。请严格按本文档执行，避免问号替换、引号不闭合、句读风格不统一等问题。

## 1. 文本目标与硬性规范
- 行结构固定：`"瑞典语原文" => "英文在前 中文在后"`
- 右侧硬性规范：
  - 不使用中文引号包中文（不要出现 “中文” 或 '中文'）
  - 中文末尾不加中文句号“。”（问号/感叹号/省略号保留）
  - 右侧引号成对完整，整行保持 `"…" => "…"`
- 左侧瑞典语（包含变音 å/ä/ö）绝不改动：
  - 不将问号版还原成变音；也不将变音写成问号
  - 任何批处理、手改，均只能改“箭头右侧”
- 占位/标记严禁改动：`%s`、`%d`、`{name}`、`{0}`、`<tag>`、`[link]`、`\n`、`\t` 等
- 专名按《专有名词与翻译对照.md》统一（Wellspring、Devotchka、SPRAK、GRIMM、Slurp()、Queen of the Internet、kronor 等）

## 2. 目录结构与关键文件
- `English/*.eng.mtf`：游戏文本主目录。左侧瑞典语，右侧双语（英文在前+中文在后）
- `背景信息/`
  - `背景信息汇总.md`：世界观/玩法/SPRAK 概览（无剧透）
  - `剧情与翻译参考详解.md`：带剧透的剧情/关系口径
  - `专有名词与翻译对照.md`：专名统一
  - `技术说明.md`（本文件）
- `tools/`
  - `format_fix_all.py`：格式矫正（只改右侧；去中文引号、去中文句末“。”、保证右侧引号完整）
  - `semantic_polish_batch.py`：语义润色批处理（只改右侧；读取源文件左侧原文，按批对照落地）
- `content_checker.py`：本地规则检查器（可按本规范更新）

## 3. 推荐工具链与职责分工
- `format_fix_all.py`（格式层）
  - 用途：批量清理右侧格式（不会做语义润色）
  - 运行：`python tools/format_fix_all.py`
  - 输出：`Processed N files, modified M lines`
  - 不会改动左侧瑞典语
- `semantic_polish_batch.py`（核心层）
  - 用途：按“本批次 canonical（规范瑞典语键）→ 目标右侧译文”的对照，**只替换右侧**
  - 关键点：
    - 先从目标文件**解析左侧原文**，构造“文件专用映射”（最终键为文件里出现的左侧原样）
    - 匹配阶段仅做“归一化比较”（非 ASCII 与 `?` 视作同类）以容忍问号版/变音版差异；**写回仍用文件的左侧原文**
    - 每次只保留**本批次**的 canonical 对照（删除旧批次），确保可追踪
  - 运行：`python tools/semantic_polish_batch.py`
  - 输出：`Polished lines: X`（命中替换的行数）
- `content_checker.py`（可选）
  - 按需增强检查规则，例如：右侧不允许中文引号、中文末尾不许为“。”、右侧引号闭合等

## 4. 语义润色标准流程（强烈执行）
1) 研读三份背景文档并统一口径：
   - `背景信息汇总.md`、`剧情与翻译参考详解.md`、`专有名词与翻译对照.md`
2) 先做一次格式矫正：`python tools/format_fix_all.py`
3) 在 `tools/semantic_polish_batch.py` 中维护本批次 canonical 对照：
   - 以**规范瑞典语键（含变音）**作为字典键；以“英文在前 中文在后”的字符串作为值
   - 示例：`'Vad gör du här?' : 'What are you doing here 你在这里做什么？'`
4) 运行脚本落地：
   - `python tools/semantic_polish_batch.py`
   - 读取目标文件 → 解析左侧 → 归一化比对 canon 键 → 用**文件的左侧原样**作为最终键 → 替换右侧
5) 验证改动：
   - 用 IDE 打开已改文件检查（Windows 终端可能显示为问号/乱码，以 IDE 内容为准）
   - 或在子仓库目录查看：`cd Game/else-heart-break-chinese && git status / git diff`
6) （可选）运行 `content_checker.py` 做二次规则检查
7) 新批次：**删除上批对照，添加新对照**，重复步骤 4～5

## 5. 编码与显示注意事项（避免“问号地狱”）
- 所有文本以 UTF‑8 保存
- 左侧瑞典语永不改动：脚本与人工编辑均不得修改、重写或重编码左侧；不要删除 + 新建文件
- 控制台回显（PowerShell/CMD）可能将 å/ä/ö 或中文显示为问号或乱码；IDE（VS Code / JetBrains）通常显示正确
- 验证以 IDE 文件内容为准，或用 `git diff` 查看行级变更

## 6. 右侧风格与口径
- 双语顺序：英文在前，中文在后
- 语气与强度：保留问号、感叹号、重复感叹（!!!）、省略号（…）等原强度
- 口语化：Pixie/Araki/Hank 等角色应保持角色口吻（见《剧情与翻译参考详解.md》）
- 货币与单位：瑞典克朗统一 `kronor`；中文依上下文简洁表达；不要随意换成“美元”
- 不添加多余引号与括注；确需注解时尽量合并在英文后中文中自然表达
- 示例（片段）：
  - `"Vad gör du här?" => "What are you doing here 你在这里做什么？"`
  - `"PLAY GAME FROM THE BEGINNING" => "PLAY GAME FROM THE BEGINNING 从头开始游戏"`
  - `"Lösenordet till datorn SKA vara abc123 om ingen har bytt" => "The password SHOULD be abc123 unless someone changed it 密码应该是 abc123，除非被人改了"`

## 7. `semantic_polish_batch.py` 关键实现（维护指南）
- 行解析：`PAIR_RE = r'^"(?P<lhs>...)"\s*=>\s*"(?P<rhs>...)"\s*$'`
- 仅用于匹配的归一化函数 `_norm_lhs(s)`：
  - 将非 ASCII 与 `?` 统一视作 `?` 用于容忍问号版/变音版左侧差异；**不写回**
- 文件专用映射构造 `_build_file_specific_mapping(canonical_map, path)`：
  - 读取文件逐行解析左侧；若 `norm(文件左侧) == norm(canonical键)`，以“文件左侧原样”为最终键、`canonical_map` 的值为目标右侧
  - 这样替换时，**永远用文件里的左侧原样**，保证不改动瑞典语
- 替换函数 `replace_pairs(path, mapping)`：
  - 遍历行；若 `lhs in mapping`，则替换右侧；写回 UTF‑8
- 每批维护：
  - 在 `main()` 中仅保留当前批次 `*_canonical` 对照，构造文件专用映射后再调用 `replace_pairs`

## 8. `format_fix_all.py` 作用点（格式层）
- 作用于右侧译文：
  - 去掉中文引号（“ ”、' ' 等）
  - 去掉中文句号“。”（问号/感叹号保留）
  - 右侧引号成对
- 不做语义润色；不动左侧

## 9. `content_checker.py` 建议规则（可扩展）
- 右侧不含中文引号（“ ”、' '）
- 中文末尾不为“。”
- 行整体匹配 `"…" => "…"`
- 可增加：占位/标记检查、重复空格、成对标点、右侧 ASCII/全角混用检查等

## 10. Git 与子仓库注意事项
- `Game/else-heart-break-chinese` 是子仓库（含独立 `.git`）
- 在父仓库根运行 `git status` 看不到子仓库改动；请进入子仓库：
  - `cd Game/else-heart-break-chinese`
  - `git status` / `git diff`
- 提交建议：
  - 每批润色完成 → `git add -A && git commit -m "polish: batch semantic updates (batch #X)"`
  - 多人协作建议以“批次编号 + 覆盖范围”命名 PR

## 11. 常见问题与排查
- 终端显示问号/乱码：以 IDE 为准；或用 `rg` / IDE 搜中文短语定位
- 脚本运行 `Polished lines: 0`：
  - 可能本批次对照已在右侧；或 canonical 键与目标文件左侧句子对不齐
  - 解决：从**源文件复制**左侧句子到 canonical 键；或检查是否为相近句（句点/大小写/空格差异）
- 切勿手动删除/新建 .mtf 文件（会破坏编码与定位），只做“就地替换右侧”
- 任何时候如发现左侧瑞典语被改动，应立即回滚并排查批处理或人工过程

## 12. 批次示例（可作为模板）
- Pixie_HackerTrial1（开场 + 取修改器）：
  - `"Vad gör du här?" => "What are you doing here 你在这里做什么？"`
  - `"Jag väntar här så länge" => "I'll wait here 我先在这等着"`
- _OnThePhone（章节菜单）：
  - `"PLAY GAME FROM THE BEGINNING" => "PLAY GAME FROM THE BEGINNING 从头开始游戏"`
- WellspringRepresentant_ShowingTheStorage（仓库/密码/纪律）：
  - `"Lösenordet till datorn SKA vara abc123 om ingen har bytt" => "The password SHOULD be abc123 unless someone changed it 密码应该是 abc123，除非被人改了"`

## 13. 协作提示
- 每批前复读三份背景文档，统一口径与术语
- 大文件优先处理“剧情主干段落”，再处理常用口头语与 UI 文本
- 若遇到难以定位的句子，先在 IDE 中**从源文件复制**左侧内容作为 canonical 键

> 任何时候，如发现左侧瑞典语被改动，应立即回滚并排查批处理脚本或人工编辑过程。

